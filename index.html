<!DOCTYPE HTML>
<html>
<head>
	<title>phaser - hello world</title>
	<script src="../phaser/build/phaser.min.js"></script>
	<script src="jquery-1.10.2.min.js"></script>
</head>
<body>

<script type="text/javascript">

var assets, folder = 'parts';

$.getJSON( folder+".json", function( data ) {
	assets = data;
})
.always(function(){
	startGame();
});

var startGame = function () {

	var game = new Phaser.Game(800, 600, Phaser.AUTO, '', { preload: preload, create: create, update: update });
	var logo, 
		keys=Phaser.Keyboard, 
		hero, 
		sprites,
		background1, 
		bgspeed = 1,
		speedFactor = 1,
		speedStep = 150, 
		bulletSpeed = 600,
		bullets,
		bulletTime = 0, 
		maxBullets = 100,
		maxObjects = 100, 
		objects = [], 
		generator;
	 
	function preload() { 		
		preloadAsset('body');
		preloadAsset('cockpit');
		preloadAsset('engine');
		preloadAsset('gun');
		preloadAsset('wing');

		game.load.image('bullet', '../phaser/examples/assets/misc/bullet0.png');
		
		game.load.image('bg','bg.jpg');
	}

	function preloadAsset(group){
		for( var i = 0; i < assets[group].length; i++ ){
			game.load.image(assets[group][i].name, folder + '/' + assets[group][i].name + ".png" );
		}
	}
	
	function create() {		
		background1 = game.add.tileSprite(0, 0, 2000, 2000, 'bg');
		game.world.setSize(2000, 2000);

		generator = new Phaser.RandomDataGenerator();
		
		$('#build').click(function(){
			regenerateShip();
		});

		$('#nextWave').click(function(){
			addRandomObjects(20, 1);
		});
		
		$('#angle').change(function(){
			hero.angle = $(this).val();
		});
		
		//hero = game.add.sprite(game.world.centerX, game.world.centerY, 'b2');
		hero = game.add.sprite(20, 20, 'b2');
		
		hero.anchor.x = 0.5;
		hero.anchor.y = 0.5;
		game.camera.follow(hero);
		
        bullets = game.add.group(null, 'bullets');

        for (var i = 0; i < maxBullets; i++)
        {
            var b = bullets.create(0, 0, 'bullet');
            b.name = 'bullet' + i;
            b.exists = false;
            b.visible = false;
            b.events.onOutOfBounds.add(resetObject, this);
        }

        objects = game.add.group(null, 'objects');

        for (var i = 0; i < maxObjects; i++)
        {
            var b = objects.create(0, 0, 'b1');
            b.name = 'object' + i;
            b.exists = false;
            b.visible = false;
            b.events.onOutOfBounds.add(resetObject, this);
        }
		
		game.input.onDown.add(fireBullet, this);
	}

	function update() {
		//logo.angle++;

		hero.body.velocity.x=hero.body.velocity.y=0;

		if(game.input.keyboard.isDown(keys.A) && !game.input.keyboard.isDown(keys.D)){
			hero.body.velocity.x = - (speedStep * speedFactor);
		}
		else if(game.input.keyboard.isDown(keys.D) && !game.input.keyboard.isDown(keys.A)){
			hero.body.velocity.x = speedStep * speedFactor;
		}

		if(game.input.keyboard.isDown(keys.W) && !game.input.keyboard.isDown(keys.S)){
			hero.body.velocity.y = - speedStep * speedFactor;
		}
		else if(game.input.keyboard.isDown(keys.S) && !game.input.keyboard.isDown(keys.W)){
			hero.body.velocity.y = speedStep * speedFactor;
		}

		moveBackground();
		lookAtPointer();
		collideObjects();
	}

	function regenerateShip() {
		//hero.visible=!hero.visible;

		hero.x = game.world.centerX;
		hero.y = game.world.centerY;
		console.log(hero.x + ' vs ' + game.world.centerX);
		console.log(hero.y + ' vs ' + game.world.centerY);
		console.log(hero);
	}

	function moveBackground() {
		background1.position.y - (bgspeed); 

	}

	function lookAtPointer() {
		hero.angle = Phaser.Math.radToDeg(Phaser.Math.angleBetween( -hero.position.y, hero.position.x, -game.input.y, game.input.x)); 
	}

	function collideObjects () {
		game.physics.collide(bullets, objects, objectHit, null, this);
	}
	
    function fireBullet () {

        if (game.time.now > bulletTime)
        {
            bullet = bullets.getFirstExists(false);

            if (bullet)
            {
                bullet.angle = hero.angle;

                bullet.anchor.x = 0.5;
                bullet.anchor.y = 0.5;
                
				var valX = game.input.x - hero.position.x; 
				var valY = - (game.input.y - hero.position.y);
				var valSum = Math.abs(valX) + Math.abs(valY);

                bullet.reset(hero.x, hero.y);
                bullet.velocity.y = - (valY / valSum) * bulletSpeed;
                bullet.velocity.x = (valX / valSum) * bulletSpeed;
                //bulletTime = game.time.now + 250;
            }
        }

    }

	function objectHit(_bullet, _obj) {
		console.log('direct hit!');
		_bullet.kill();
		_obj.kill();
	}
    
    //  Called if the bullet goes out of the screen
    function resetObject (obj) {
    	obj.kill();
    }

    function addRandomObjects (count, level) {
        for (i=0; i<count; i++) {

            obj = objects.getFirstExists(false);

            if (obj)
            {
            	obj.anchor.x = 0.5;
            	obj.anchor.y = 0.5;

            	obj.reset(- generator.integerInRange(0, 100), - generator.integerInRange(0, 100));
            	obj.velocity.x = generator.integerInRange(100, 160);
            	obj.velocity.y = generator.integerInRange(100, 160);
                //bulletTime = game.time.now + 250;
            }
        }
    }
};

</script>

<div id="gui">
	<button id="build">regenerate ship</button>
	<button id="nextWave">next wave</button>
	<input id="angle" value="0" />
</div>

</body>
</html>

